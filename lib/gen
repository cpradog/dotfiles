#!/usr/bin/env sh

##!
# generate file from template(s).
#
# All template files are ordered before evaluated.
#
# $1 - the file to generate.
# $* - one or more template files or directories with templates.
##
gen_file() {
  target=$1
  shift
  source=$*

  # shellcheck disable=2086 ## we need word splitting here to support multiple inputs
  source_files=$(find -L $source -type f -printf '%f\t%p\n' |
              sort -k1 |
              cut -d"$(printf '\t')" -f2)

  debug "generating '$target' from:"
  for src in $source_files; do
    debug "  - $src"
  done

  {
    echo "################################################################################"
    echo "##                                                                            ##"
    echo "##                               GENERATED FILE                               ##"
    echo "##                                                                            ##"
    echo "##   Any change to this file will be lost when updated. Please, use the       ##"
    echo "## proper configuration files to change the content and regenerate the file.  ##"
    echo "##                                                                            ##"
    echo "################################################################################"

    echo "#+BEGIN metadata"
    echo "# last updated: $(date -u)"
    echo "# generated by dotfiles package: $PN"
    echo "# generated from:"
    for dir in $source_files; do
      echo "#  - $dir"
    done
    echo "#+END metadata"

    for file in $source_files; do
      echo ""
      echo "#+BEGIN ${file##*/}"
      cat "$file"
      echo ""
      echo "#+END ${file##*/}"
    done
  } | "$DOTFILES_LIB/../tools/esh" -o "$target" -
}
